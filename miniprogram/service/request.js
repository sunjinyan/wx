"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Coolcar = void 0;
const camelcaseKeys = require("camelcase-keys");
const auth_pb_1 = require("./proto_gen/auth/auth_pb");
var Coolcar;
(function (Coolcar) {
    Coolcar.serverAddr = 'http://coolcar.dreaminglifes.com';
    Coolcar.wsAddr = 'wx://localhost:9091';
    const AUTH_ERR = 'AUTH_ERR';
    const authData = {
        token: '',
        expireMs: 0,
    };
    async function sendRequestWithAuthRetry(o, a) {
        await login();
        const authOpt = a || {
            attachAuthHeader: true,
            retryOnAuthError: true,
        };
        try {
            await login();
            return sendRequest(o, authOpt);
        }
        catch (err) {
            if (err === AUTH_ERR && authOpt.retryOnAuthError) {
                authData.token = '';
                authData.expireMs = 0;
                return sendRequestWithAuthRetry(o, {
                    attachAuthHeader: authOpt.attachAuthHeader,
                    retryOnAuthError: false,
                });
            }
            else {
                throw err;
            }
        }
    }
    Coolcar.sendRequestWithAuthRetry = sendRequestWithAuthRetry;
    async function login() {
        if (authData.token && authData.expireMs >= Date.now()) {
            return;
        }
        const wxResp = await wxLogin();
        const resp = await sendRequest({
            method: 'POST',
            path: '/v1/auth/login',
            data: {
                code: wxResp.code,
            },
            respMarshaller: auth_pb_1.auth.v1.LoginResponse.fromObject,
        }, {
            attachAuthHeader: false,
            retryOnAuthError: false,
        });
        authData.token = resp.accessToken;
        authData.expireMs = Date.now() + resp.expiresIn * 1000;
    }
    Coolcar.login = login;
    function sendRequest(o, a) {
        const authOpt = a || {
            attachAuthHeader: true,
        };
        return new Promise((resolve, reject) => {
            const header = {};
            if (a.attachAuthHeader) {
                if (authData.token && authData.expireMs >= Date.now()) {
                    header.authorization = 'Bearer ' + authData.token;
                }
                else {
                    reject(AUTH_ERR);
                    return;
                }
            }
            if (authOpt.attachAuthHeader && authData.token && authData.expireMs >= Date.now()) {
                header.authorization = 'Bearer ' + authData.token;
            }
            wx.request({
                url: Coolcar.serverAddr + o.path,
                method: o.method,
                data: o.data,
                header,
                success: res => {
                    if (res.statusCode === 401) {
                        reject(AUTH_ERR);
                    }
                    else if (res.statusCode >= 400) {
                        reject(res);
                    }
                    else {
                        resolve(o.respMarshaller(camelcaseKeys(res.data, {
                            deep: true,
                        })));
                    }
                },
                fail: reject
            });
        });
    }
    function wxLogin() {
        return new Promise((resolve, reject) => {
            wx.login({
                success: resolve,
                fail: reject
            });
        });
    }
    function uploadfile(o) {
        const data = wx.getFileSystemManager().readFileSync(o.localPath);
        return new Promise((resolve, reject) => {
            wx.request({
                method: "PUT",
                data,
                url: o.url,
                success: res => {
                    if (res.statusCode >= 400) {
                        reject(res);
                    }
                    else {
                        resolve();
                    }
                },
                fail: reject,
            });
        });
    }
    Coolcar.uploadfile = uploadfile;
    function wxUploadFile(o, a) {
        const authOpt = a || {
            attachAuthHeader: true,
        };
        return new Promise((resolve, reject) => {
            const header = {};
            if (a.attachAuthHeader) {
                if (authData.token && authData.expireMs >= Date.now()) {
                    header.authorization = 'Bearer ' + authData.token;
                }
                else {
                    reject(AUTH_ERR);
                    return;
                }
            }
            if (authOpt.attachAuthHeader && authData.token && authData.expireMs >= Date.now()) {
                header.authorization = 'Bearer ' + authData.token;
            }
            wx.uploadFile({
                url: Coolcar.serverAddr + o.url,
                filePath: o.filePath,
                name: o.name,
                formData: o.formData,
                header,
                success: r => {
                    resolve(o.respMarshaller(r));
                },
                fail: reject
            });
        });
    }
    Coolcar.wxUploadFile = wxUploadFile;
})(Coolcar = exports.Coolcar || (exports.Coolcar = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0RBQWdEO0FBQ2hELHNEQUErQztBQUUvQyxJQUFpQixPQUFPLENBb012QjtBQXBNRCxXQUFpQixPQUFPO0lBRVAsa0JBQVUsR0FBRyxrQ0FBa0MsQ0FBQTtJQUMvQyxjQUFNLEdBQUcscUJBQXFCLENBQUE7SUFDM0MsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFBO0lBRTNCLE1BQU0sUUFBUSxHQUFHO1FBQ2IsS0FBSyxFQUFDLEVBQUU7UUFDUixRQUFRLEVBQUMsQ0FBQztLQUNiLENBQUE7SUFjTSxLQUFLLFVBQVUsd0JBQXdCLENBQVUsQ0FBd0IsRUFBQyxDQUFhO1FBQzFGLE1BQU0sS0FBSyxFQUFFLENBQUE7UUFDYixNQUFNLE9BQU8sR0FBRyxDQUFDLElBQUk7WUFDakIsZ0JBQWdCLEVBQUUsSUFBSTtZQUN0QixnQkFBZ0IsRUFBRSxJQUFJO1NBQ3pCLENBQUE7UUFDRCxJQUFJO1lBQ0EsTUFBTSxLQUFLLEVBQUUsQ0FBQTtZQUNiLE9BQU8sV0FBVyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQTtTQUNqQztRQUFDLE9BQU0sR0FBRyxFQUFFO1lBQ1QsSUFBSSxHQUFHLEtBQUssUUFBUSxJQUFJLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDOUMsUUFBUSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUE7Z0JBQ25CLFFBQVEsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFBO2dCQUNyQixPQUFPLHdCQUF3QixDQUFDLENBQUMsRUFBRTtvQkFDL0IsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLGdCQUFnQjtvQkFDMUMsZ0JBQWdCLEVBQUUsS0FBSztpQkFDMUIsQ0FBQyxDQUFBO2FBQ0w7aUJBQU07Z0JBQ0gsTUFBTSxHQUFHLENBQUE7YUFDWjtTQUNKO0lBQ0wsQ0FBQztJQXJCcUIsZ0NBQXdCLDJCQXFCN0MsQ0FB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QUFTLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQTtpQkFDcEQ7cUJBQU07b0JBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO29CQUNoQixPQUFNO2lCQUNUO2FBQ0o7WUFDRCxJQUFJLE9BQU8sQ0FBQyxnQkFBZ0IsSUFBSSxRQUFRLENBQUMsS0FBSyxJQUFJLFFBQVEsQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFDO2dCQUM5RSxNQUFNLENBQUMsYUFBYSxHQUFHLFNBQVMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFBO2FBQ3BEO1lBRUQsRUFBRSxDQUFDLFVBQVUsQ0FBQztnQkFDVixHQUFHLEVBQUMsUUFBQSxVQUFVLEdBQUMsQ0FBQyxDQUFDLEdBQUc7Z0JBQ3BCLFFBQVEsRUFBRSxDQUFDLENBQUMsUUFBUTtnQkFDcEIsSUFBSSxFQUFDLENBQUMsQ0FBQyxJQUFJO2dCQUNYLFFBQVEsRUFBQyxDQUFDLENBQUMsUUFBUTtnQkFDbkIsTUFBTTtnQkFNTixPQUFPLEVBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ1IsT0FBTyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDaEMsQ0FBQztnQkFDRCxJQUFJLEVBQUMsTUFBTTthQUNkLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQXZDZSxvQkFBWSxlQXVDM0IsQ0FBQTtBQUNMLENBQUMsRUFwTWdCLE9BQU8sR0FBUCxlQUFPLEtBQVAsZUFBTyxRQW9NdkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2FtZWxjYXNlS2V5cyA9IHJlcXVpcmUoXCJjYW1lbGNhc2Uta2V5c1wiKVxyXG5pbXBvcnQgeyBhdXRoIH0gZnJvbSBcIi4vcHJvdG9fZ2VuL2F1dGgvYXV0aF9wYlwiXHJcblxyXG5leHBvcnQgbmFtZXNwYWNlIENvb2xjYXJ7XHJcblxyXG4gICAgZXhwb3J0IGNvbnN0IHNlcnZlckFkZHIgPSAnaHR0cDovL2Nvb2xjYXIuZHJlYW1pbmdsaWZlcy5jb20nXHJcbiAgICBleHBvcnQgY29uc3Qgd3NBZGRyID0gJ3d4Oi8vbG9jYWxob3N0OjkwOTEnXHJcbiAgICBjb25zdCBBVVRIX0VSUiA9ICdBVVRIX0VSUidcclxuXHJcbiAgICBjb25zdCBhdXRoRGF0YSA9IHtcclxuICAgICAgICB0b2tlbjonJyxcclxuICAgICAgICBleHBpcmVNczowLFxyXG4gICAgfVxyXG5cclxuICAgIGludGVyZmFjZSBSZXF1ZXN0T3B0aW9uPFJFUSxSRVM+e1xyXG4gICAgICAgIG1ldGhvZDogJ0dFVCd8J1BVVCd8J1BPU1QnfCdERUxFVEUnXHJcbiAgICAgICAgcGF0aDpzdHJpbmdcclxuICAgICAgICBkYXRhPzogUkVRXHJcbiAgICAgICAgcmVzcE1hcnNoYWxsZXI6KHI6b2JqZWN0KT0+UkVTXHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGludGVyZmFjZSBBdXRoT3B0aW9ue1xyXG4gICAgICAgIGF0dGFjaEF1dGhIZWFkZXI6Ym9vbGVhblxyXG4gICAgICAgIHJldHJ5T25BdXRoRXJyb3I6IGJvb2xlYW5cclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gc2VuZFJlcXVlc3RXaXRoQXV0aFJldHJ5PFJFUSxSRVM+KG86UmVxdWVzdE9wdGlvbjxSRVEsUkVTPixhPzpBdXRoT3B0aW9uKTogUHJvbWlzZTxSRVM+ICB7XHJcbiAgICAgICAgYXdhaXQgbG9naW4oKVxyXG4gICAgICAgIGNvbnN0IGF1dGhPcHQgPSBhIHx8IHtcclxuICAgICAgICAgICAgYXR0YWNoQXV0aEhlYWRlcjogdHJ1ZSxcclxuICAgICAgICAgICAgcmV0cnlPbkF1dGhFcnJvcjogdHJ1ZSxcclxuICAgICAgICB9XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgYXdhaXQgbG9naW4oKVxyXG4gICAgICAgICAgICByZXR1cm4gc2VuZFJlcXVlc3QobywgYXV0aE9wdClcclxuICAgICAgICB9IGNhdGNoKGVycikge1xyXG4gICAgICAgICAgICBpZiAoZXJyID09PSBBVVRIX0VSUiAmJiBhdXRoT3B0LnJldHJ5T25BdXRoRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGF1dGhEYXRhLnRva2VuID0gJydcclxuICAgICAgICAgICAgICAgIGF1dGhEYXRhLmV4cGlyZU1zID0gMFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNlbmRSZXF1ZXN0V2l0aEF1dGhSZXRyeShvLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXR0YWNoQXV0aEhlYWRlcjogYXV0aE9wdC5hdHRhY2hBdXRoSGVhZGVyLFxyXG4gICAgICAgICAgICAgICAgICAgIHJldHJ5T25BdXRoRXJyb3I6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IGVyclxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2dpbigpIHtcclxuICAgICAgICBpZiAoYXV0aERhdGEudG9rZW4gJiYgYXV0aERhdGEuZXhwaXJlTXMgPj0gRGF0ZS5ub3coKSl7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB3eFJlc3AgPSBhd2FpdCB3eExvZ2luKClcclxuICAgICAgICBjb25zdCByZXNwID0gYXdhaXQgc2VuZFJlcXVlc3Q8YXV0aC52MS5JTG9naW5SZXF1ZXN0LCBhdXRoLnYxLklMb2dpblJlc3BvbnNlPih7XHJcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxyXG4gICAgICAgICAgICBwYXRoOiAnL3YxL2F1dGgvbG9naW4nLFxyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICBjb2RlOiB3eFJlc3AuY29kZSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVzcE1hcnNoYWxsZXI6IGF1dGgudjEuTG9naW5SZXNwb25zZS5mcm9tT2JqZWN0LFxyXG4gICAgICAgIH0se1xyXG4gICAgICAgICAgICBhdHRhY2hBdXRoSGVhZGVyOiBmYWxzZSxcclxuICAgICAgICAgICAgcmV0cnlPbkF1dGhFcnJvcjogZmFsc2UsXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgYXV0aERhdGEudG9rZW4gPSByZXNwLmFjY2Vzc1Rva2VuIVxyXG4gICAgICAgIGF1dGhEYXRhLmV4cGlyZU1zID0gRGF0ZS5ub3coKSArIHJlc3AuZXhwaXJlc0luISAqIDEwMDBcclxuXHJcbiAgICB9XHJcblxyXG5cclxuICAgIGZ1bmN0aW9uIHNlbmRSZXF1ZXN0PFJFUSxSRVM+KG86IFJlcXVlc3RPcHRpb248UkVRLCBSRVM+LCBhOiBBdXRoT3B0aW9uKTogUHJvbWlzZTxSRVM+IHtcclxuICAgICAgICBjb25zdCBhdXRoT3B0ID0gYSB8fCB7XHJcbiAgICAgICAgICAgIGF0dGFjaEF1dGhIZWFkZXI6dHJ1ZSxcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLHJlamVjdCk9PntcclxuICAgICAgICAgICAgY29uc3QgaGVhZGVyIDogUmVjb3JkPHN0cmluZyxhbnk+ID0ge30vL+mBv+WFjeS4i+i+ueeahGhlYWRlci5hdXRob3JpemF0aW9uIOeCueS4jeWHuuadpeS4nOilv1xyXG4gICAgICAgICAgICBpZiAoYS5hdHRhY2hBdXRoSGVhZGVyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXV0aERhdGEudG9rZW4gJiYgYXV0aERhdGEuZXhwaXJlTXMgPj0gRGF0ZS5ub3coKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGhlYWRlci5hdXRob3JpemF0aW9uID0gJ0JlYXJlciAnICsgYXV0aERhdGEudG9rZW5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KEFVVEhfRVJSKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhdXRoT3B0LmF0dGFjaEF1dGhIZWFkZXIgJiYgYXV0aERhdGEudG9rZW4gJiYgYXV0aERhdGEuZXhwaXJlTXMgPj0gRGF0ZS5ub3coKSl7XHJcbiAgICAgICAgICAgICAgICBoZWFkZXIuYXV0aG9yaXphdGlvbiA9ICdCZWFyZXIgJyArIGF1dGhEYXRhLnRva2VuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICAgICAgICB1cmw6c2VydmVyQWRkcitvLnBhdGgsXHJcbiAgICAgICAgICAgICAgICBtZXRob2Q6by5tZXRob2QsXHJcbiAgICAgICAgICAgICAgICBkYXRhOm8uZGF0YSxcclxuICAgICAgICAgICAgICAgIGhlYWRlcixcclxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6cmVzPT57XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09PSA0MDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KEFVVEhfRVJSKVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzLnN0YXR1c0NvZGUgPj0gNDAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChyZXMpXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvLnJlc3BNYXJzaGFsbGVyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FtZWxjYXNlS2V5cyhyZXMuZGF0YSBhcyBvYmplY3QsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWVwOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBmYWlsOnJlamVjdFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gd3hMb2dpbigpOlByb21pc2U8V2VjaGF0TWluaXByb2dyYW0uTG9naW5TdWNjZXNzQ2FsbGJhY2tSZXN1bHQ+e1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSxyZWplY3QpPT57XHJcbiAgICAgICAgICAgIHd4LmxvZ2luKHtcclxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6cmVzb2x2ZSxcclxuICAgICAgICAgICAgICAgIGZhaWw6cmVqZWN0XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgaW50ZXJmYWNlIFVwbG9hZEZpbGVPcHRzIHtcclxuICAgICAgICBsb2NhbFBhdGg6IHN0cmluZ1xyXG4gICAgICAgIHVybDogc3RyaW5nXHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGZ1bmN0aW9uIHVwbG9hZGZpbGUobzpVcGxvYWRGaWxlT3B0cyk6UHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IHd4LmdldEZpbGVTeXN0ZW1NYW5hZ2VyKCkucmVhZEZpbGVTeW5jKG8ubG9jYWxQYXRoKVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUscmVqZWN0KT0+e1xyXG4gICAgICAgICAgICB3eC5yZXF1ZXN0KHtcclxuICAgICAgICAgICAgICAgIG1ldGhvZDpcIlBVVFwiLFxyXG4gICAgICAgICAgICAgICAgZGF0YSxcclxuICAgICAgICAgICAgICAgIHVybDpvLnVybCxcclxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6cmVzID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPj0gNDAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChyZXMpICAgXHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKVxyXG4gICAgICAgICAgICAgICAgICAgIH0gICAgXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZmFpbDpyZWplY3QsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGludGVyZmFjZSB3eFVwbG9hZEZpbGVPcHRzIHtcclxuICAgICAgICBsb2NhbFBhdGg6IHN0cmluZ1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBleHBvcnQgaW50ZXJmYWNlIFVwbG9hZE9wdGlvbjxVUFJFUSxVUFJFUz57XHJcbiAgICAgICAgZmlsZVBhdGg6IHN0cmluZyxcclxuICAgICAgICB1cmw6c3RyaW5nLFxyXG4gICAgICAgIG5hbWU6c3RyaW5nLFxyXG4gICAgICAgIGZvcm1EYXRhOlVQUkVRLFxyXG4gICAgICAgIHJlc3BNYXJzaGFsbGVyOihyOm9iamVjdCk9PlVQUkVTXHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGZ1bmN0aW9uIHd4VXBsb2FkRmlsZTxVUFJFUSxVUFJFUz4obzogVXBsb2FkT3B0aW9uPFVQUkVRLCBVUFJFUz4sIGE6IEF1dGhPcHRpb24pOlByb21pc2U8VVBSRVM+IHtcclxuICAgICAgICBjb25zdCBhdXRoT3B0ID0gYSB8fCB7XHJcbiAgICAgICAgICAgIGF0dGFjaEF1dGhIZWFkZXI6dHJ1ZSxcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgaGVhZGVyIDogUmVjb3JkPHN0cmluZyxhbnk+ID0ge1xyXG4gICAgICAgICAgICAgICAgLy8nQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247dXRmLTgnXHJcbiAgICAgICAgICAgIH0vL+mBv+WFjeS4i+i+ueeahGhlYWRlci5hdXRob3JpemF0aW9uIOeCueS4jeWHuuadpeS4nOilv1xyXG4gICAgICAgICAgICBpZiAoYS5hdHRhY2hBdXRoSGVhZGVyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXV0aERhdGEudG9rZW4gJiYgYXV0aERhdGEuZXhwaXJlTXMgPj0gRGF0ZS5ub3coKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGhlYWRlci5hdXRob3JpemF0aW9uID0gJ0JlYXJlciAnICsgYXV0aERhdGEudG9rZW5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KEFVVEhfRVJSKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhdXRoT3B0LmF0dGFjaEF1dGhIZWFkZXIgJiYgYXV0aERhdGEudG9rZW4gJiYgYXV0aERhdGEuZXhwaXJlTXMgPj0gRGF0ZS5ub3coKSl7XHJcbiAgICAgICAgICAgICAgICBoZWFkZXIuYXV0aG9yaXphdGlvbiA9ICdCZWFyZXIgJyArIGF1dGhEYXRhLnRva2VuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHd4LnVwbG9hZEZpbGUoe1xyXG4gICAgICAgICAgICAgICAgdXJsOnNlcnZlckFkZHIrby51cmwsXHJcbiAgICAgICAgICAgICAgICBmaWxlUGF0aDogby5maWxlUGF0aCxcclxuICAgICAgICAgICAgICAgIG5hbWU6by5uYW1lLFxyXG4gICAgICAgICAgICAgICAgZm9ybURhdGE6by5mb3JtRGF0YSxcclxuICAgICAgICAgICAgICAgIGhlYWRlcixcclxuICAgICAgICAgICAgICAgIC8vIGhlYWRlcnMgOiB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICd0aW1lc3RhbXAnOiAnMTY0MTcwNDMzNycsXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICdhdXRob3JpemF0aW9uJzogJzFENjNFNkYxRjhBRjdCRDYyOUM2ODRBMTQ0NjgzMjI2JyxcclxuICAgICAgICAgICAgICAgIC8vICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uO3V0Zi04J1xyXG4gICAgICAgICAgICAgICAgLy8gfSxcclxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6ciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvLnJlc3BNYXJzaGFsbGVyKHIpKVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGZhaWw6cmVqZWN0XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSlcclxuICAgIH1cclxufSJdfQ==