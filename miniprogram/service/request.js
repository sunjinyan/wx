"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Coolcar = void 0;
const camelcaseKeys = require("camelcase-keys");
const auth_pb_1 = require("./proto_gen/auth/auth_pb");
var Coolcar;
(function (Coolcar) {
    const serverAddr = 'http://localhost:8080';
    const AUTH_ERR = 'AUTH_ERR';
    const authData = {
        token: '',
        expireMs: 0,
    };
    async function sendRequestWithAuthRetry(o, a) {
        await login();
        const authOpt = a || {
            attachAuthHeader: true,
            retryOnAuthError: true,
        };
        try {
            await login();
            return sendRequest(o, authOpt);
        }
        catch (err) {
            if (err === AUTH_ERR && authOpt.retryOnAuthError) {
                authData.token = '';
                authData.expireMs = 0;
                return sendRequestWithAuthRetry(o, {
                    attachAuthHeader: authOpt.attachAuthHeader,
                    retryOnAuthError: false,
                });
            }
            else {
                throw err;
            }
        }
    }
    Coolcar.sendRequestWithAuthRetry = sendRequestWithAuthRetry;
    async function login() {
        if (authData.token && authData.expireMs >= Date.now()) {
            return;
        }
        const wxResp = await wxLogin();
        const resp = await sendRequest({
            method: 'POST',
            path: '/v1/auth/login',
            data: {
                code: wxResp.code,
            },
            respMarshaller: auth_pb_1.auth.v1.LoginResponse.fromObject,
        }, {
            attachAuthHeader: false,
            retryOnAuthError: false,
        });
        authData.token = resp.accessToken;
        authData.expireMs = Date.now() + resp.expiresIn * 1000;
    }
    Coolcar.login = login;
    function sendRequest(o, a) {
        const authOpt = a || {
            attachAuthHeader: true,
        };
        return new Promise((resolve, reject) => {
            const header = {};
            if (a.attachAuthHeader) {
                if (authData.token && authData.expireMs >= Date.now()) {
                    header.authorization = 'Bearer ' + authData.token;
                }
                else {
                    reject(AUTH_ERR);
                    return;
                }
            }
            if (authOpt.attachAuthHeader && authData.token && authData.expireMs >= Date.now()) {
                header.authorization = 'Bearer ' + authData.token;
            }
            wx.request({
                url: serverAddr + o.path,
                method: o.method,
                data: o.data,
                header,
                success: res => {
                    if (res.statusCode === 401) {
                        reject(AUTH_ERR);
                    }
                    else if (res.statusCode >= 400) {
                        reject(res);
                    }
                    else {
                        resolve(o.respMarshaller(camelcaseKeys(res.data, {
                            deep: true,
                        })));
                    }
                },
                fail: reject
            });
        });
    }
    function wxLogin() {
        return new Promise((resolve, reject) => {
            wx.login({
                success: resolve,
                fail: reject
            });
        });
    }
})(Coolcar = exports.Coolcar || (exports.Coolcar = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0RBQWdEO0FBQ2hELHNEQUErQztBQUUvQyxJQUFpQixPQUFPLENBb0h2QjtBQXBIRCxXQUFpQixPQUFPO0lBRXBCLE1BQU0sVUFBVSxHQUFHLHVCQUF1QixDQUFBO0lBQzFDLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQTtJQUUzQixNQUFNLFFBQVEsR0FBRztRQUNiLEtBQUssRUFBQyxFQUFFO1FBQ1IsUUFBUSxFQUFDLENBQUM7S0FDYixDQUFBO0lBY00sS0FBSyxVQUFVLHdCQUF3QixDQUFVLENBQXdCLEVBQUMsQ0FBYTtRQUMxRixNQUFNLEtBQUssRUFBRSxDQUFBO1FBQ2IsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJO1lBQ2pCLGdCQUFnQixFQUFFLElBQUk7WUFDdEIsZ0JBQWdCLEVBQUUsSUFBSTtTQUN6QixDQUFBO1FBQ0QsSUFBSTtZQUNBLE1BQU0sS0FBSyxFQUFFLENBQUE7WUFDYixPQUFPLFdBQVcsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUE7U0FDakM7UUFBQyxPQUFNLEdBQUcsRUFBRTtZQUNULElBQUksR0FBRyxLQUFLLFFBQVEsSUFBSSxPQUFPLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQzlDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFBO2dCQUNuQixRQUFRLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQTtnQkFDckIsT0FBTyx3QkFBd0IsQ0FBQyxDQUFDLEVBQUU7b0JBQy9CLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxnQkFBZ0I7b0JBQzFDLGdCQUFnQixFQUFFLEtBQUs7aUJBQzFCLENBQUMsQ0FBQTthQUNMO2lCQUFNO2dCQUNILE1BQU0sR0FBRyxDQUFBO2FBQ1o7U0FDSjtJQUNMLENBQUM7SUFyQnFCLGdDQUF3QiwyQkFxQjdDLENBQUE7SUFFTSxLQUFLLFVBQVUsS0FBSztR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O2FBQ2QsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0FBRUwsQ0FBQyxFQXBIZ0IsT0FBTyxHQUFQLGVBQU8sS0FBUCxlQUFPLFFBb0h2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjYW1lbGNhc2VLZXlzID0gcmVxdWlyZShcImNhbWVsY2FzZS1rZXlzXCIpXHJcbmltcG9ydCB7IGF1dGggfSBmcm9tIFwiLi9wcm90b19nZW4vYXV0aC9hdXRoX3BiXCJcclxuXHJcbmV4cG9ydCBuYW1lc3BhY2UgQ29vbGNhcntcclxuXHJcbiAgICBjb25zdCBzZXJ2ZXJBZGRyID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6ODA4MCdcclxuICAgIGNvbnN0IEFVVEhfRVJSID0gJ0FVVEhfRVJSJ1xyXG5cclxuICAgIGNvbnN0IGF1dGhEYXRhID0ge1xyXG4gICAgICAgIHRva2VuOicnLFxyXG4gICAgICAgIGV4cGlyZU1zOjAsXHJcbiAgICB9XHJcblxyXG4gICAgaW50ZXJmYWNlIFJlcXVlc3RPcHRpb248UkVRLFJFUz57XHJcbiAgICAgICAgbWV0aG9kOiAnR0VUJ3wnUFVUJ3wnUE9TVCd8J0RFTEVURSdcclxuICAgICAgICBwYXRoOnN0cmluZ1xyXG4gICAgICAgIGRhdGE/OiBSRVFcclxuICAgICAgICByZXNwTWFyc2hhbGxlcjoocjpvYmplY3QpPT5SRVNcclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgaW50ZXJmYWNlIEF1dGhPcHRpb257XHJcbiAgICAgICAgYXR0YWNoQXV0aEhlYWRlcjpib29sZWFuXHJcbiAgICAgICAgcmV0cnlPbkF1dGhFcnJvcjogYm9vbGVhblxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZW5kUmVxdWVzdFdpdGhBdXRoUmV0cnk8UkVRLFJFUz4obzpSZXF1ZXN0T3B0aW9uPFJFUSxSRVM+LGE/OkF1dGhPcHRpb24pOiBQcm9taXNlPFJFUz4gIHtcclxuICAgICAgICBhd2FpdCBsb2dpbigpXHJcbiAgICAgICAgY29uc3QgYXV0aE9wdCA9IGEgfHwge1xyXG4gICAgICAgICAgICBhdHRhY2hBdXRoSGVhZGVyOiB0cnVlLFxyXG4gICAgICAgICAgICByZXRyeU9uQXV0aEVycm9yOiB0cnVlLFxyXG4gICAgICAgIH1cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCBsb2dpbigpXHJcbiAgICAgICAgICAgIHJldHVybiBzZW5kUmVxdWVzdChvLCBhdXRoT3B0KVxyXG4gICAgICAgIH0gY2F0Y2goZXJyKSB7XHJcbiAgICAgICAgICAgIGlmIChlcnIgPT09IEFVVEhfRVJSICYmIGF1dGhPcHQucmV0cnlPbkF1dGhFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgYXV0aERhdGEudG9rZW4gPSAnJ1xyXG4gICAgICAgICAgICAgICAgYXV0aERhdGEuZXhwaXJlTXMgPSAwXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc2VuZFJlcXVlc3RXaXRoQXV0aFJldHJ5KG8sIHtcclxuICAgICAgICAgICAgICAgICAgICBhdHRhY2hBdXRoSGVhZGVyOiBhdXRoT3B0LmF0dGFjaEF1dGhIZWFkZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0cnlPbkF1dGhFcnJvcjogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvZ2luKCkge1xyXG4gICAgICAgIGlmIChhdXRoRGF0YS50b2tlbiAmJiBhdXRoRGF0YS5leHBpcmVNcyA+PSBEYXRlLm5vdygpKXtcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHd4UmVzcCA9IGF3YWl0IHd4TG9naW4oKVxyXG4gICAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBzZW5kUmVxdWVzdDxhdXRoLnYxLklMb2dpblJlcXVlc3QsIGF1dGgudjEuSUxvZ2luUmVzcG9uc2U+KHtcclxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIHBhdGg6ICcvdjEvYXV0aC9sb2dpbicsXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGNvZGU6IHd4UmVzcC5jb2RlLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZXNwTWFyc2hhbGxlcjogYXV0aC52MS5Mb2dpblJlc3BvbnNlLmZyb21PYmplY3QsXHJcbiAgICAgICAgfSx7XHJcbiAgICAgICAgICAgIGF0dGFjaEF1dGhIZWFkZXI6IGZhbHNlLFxyXG4gICAgICAgICAgICByZXRyeU9uQXV0aEVycm9yOiBmYWxzZSxcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICBhdXRoRGF0YS50b2tlbiA9IHJlc3AuYWNjZXNzVG9rZW4hXHJcbiAgICAgICAgYXV0aERhdGEuZXhwaXJlTXMgPSBEYXRlLm5vdygpICsgcmVzcC5leHBpcmVzSW4hICogMTAwMFxyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgZnVuY3Rpb24gc2VuZFJlcXVlc3Q8UkVRLFJFUz4obzogUmVxdWVzdE9wdGlvbjxSRVEsIFJFUz4sIGE6IEF1dGhPcHRpb24pOiBQcm9taXNlPFJFUz4ge1xyXG4gICAgICAgIGNvbnN0IGF1dGhPcHQgPSBhIHx8IHtcclxuICAgICAgICAgICAgYXR0YWNoQXV0aEhlYWRlcjp0cnVlLFxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUscmVqZWN0KT0+e1xyXG4gICAgICAgICAgICBjb25zdCBoZWFkZXIgOiBSZWNvcmQ8c3RyaW5nLGFueT4gPSB7fS8v6YG/5YWN5LiL6L6555qEaGVhZGVyLmF1dGhvcml6YXRpb24g54K55LiN5Ye65p2l5Lic6KW/XHJcbiAgICAgICAgICAgIGlmIChhLmF0dGFjaEF1dGhIZWFkZXIpIHtcclxuICAgICAgICAgICAgICAgIGlmIChhdXRoRGF0YS50b2tlbiAmJiBhdXRoRGF0YS5leHBpcmVNcyA+PSBEYXRlLm5vdygpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyLmF1dGhvcml6YXRpb24gPSAnQmVhcmVyICcgKyBhdXRoRGF0YS50b2tlblxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoQVVUSF9FUlIpXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGF1dGhPcHQuYXR0YWNoQXV0aEhlYWRlciAmJiBhdXRoRGF0YS50b2tlbiAmJiBhdXRoRGF0YS5leHBpcmVNcyA+PSBEYXRlLm5vdygpKXtcclxuICAgICAgICAgICAgICAgIGhlYWRlci5hdXRob3JpemF0aW9uID0gJ0JlYXJlciAnICsgYXV0aERhdGEudG9rZW5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB3eC5yZXF1ZXN0KHtcclxuICAgICAgICAgICAgICAgIHVybDpzZXJ2ZXJBZGRyK28ucGF0aCxcclxuICAgICAgICAgICAgICAgIG1ldGhvZDpvLm1ldGhvZCxcclxuICAgICAgICAgICAgICAgIGRhdGE6by5kYXRhLFxyXG4gICAgICAgICAgICAgICAgaGVhZGVyLFxyXG4gICAgICAgICAgICAgICAgc3VjY2VzczpyZXM9PntcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDQwMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoQVVUSF9FUlIpXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXMuc3RhdHVzQ29kZSA+PSA0MDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHJlcylcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG8ucmVzcE1hcnNoYWxsZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW1lbGNhc2VLZXlzKHJlcy5kYXRhIGFzIG9iamVjdCwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZXA6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSkpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGZhaWw6cmVqZWN0XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB3eExvZ2luKCk6UHJvbWlzZTxXZWNoYXRNaW5pcHJvZ3JhbS5Mb2dpblN1Y2Nlc3NDYWxsYmFja1Jlc3VsdD57XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLHJlamVjdCk9PntcclxuICAgICAgICAgICAgd3gubG9naW4oe1xyXG4gICAgICAgICAgICAgICAgc3VjY2VzczpyZXNvbHZlLFxyXG4gICAgICAgICAgICAgICAgZmFpbDpyZWplY3RcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxufSJdfQ==