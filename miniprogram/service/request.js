"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Coolcar = void 0;
const camelcaseKeys = require("camelcase-keys");
const auth_pb_1 = require("./proto_gen/auth/auth_pb");
var Coolcar;
(function (Coolcar) {
    Coolcar.serverAddr = 'http://localhost:8080';
    Coolcar.wsAddr = 'wx://localhost:9091';
    const AUTH_ERR = 'AUTH_ERR';
    const authData = {
        token: '',
        expireMs: 0,
    };
    async function sendRequestWithAuthRetry(o, a) {
        await login();
        const authOpt = a || {
            attachAuthHeader: true,
            retryOnAuthError: true,
        };
        try {
            await login();
            return sendRequest(o, authOpt);
        }
        catch (err) {
            if (err === AUTH_ERR && authOpt.retryOnAuthError) {
                authData.token = '';
                authData.expireMs = 0;
                return sendRequestWithAuthRetry(o, {
                    attachAuthHeader: authOpt.attachAuthHeader,
                    retryOnAuthError: false,
                });
            }
            else {
                throw err;
            }
        }
    }
    Coolcar.sendRequestWithAuthRetry = sendRequestWithAuthRetry;
    async function login() {
        if (authData.token && authData.expireMs >= Date.now()) {
            return;
        }
        const wxResp = await wxLogin();
        const resp = await sendRequest({
            method: 'POST',
            path: '/v1/auth/login',
            data: {
                code: wxResp.code,
            },
            respMarshaller: auth_pb_1.auth.v1.LoginResponse.fromObject,
        }, {
            attachAuthHeader: false,
            retryOnAuthError: false,
        });
        authData.token = resp.accessToken;
        authData.expireMs = Date.now() + resp.expiresIn * 1000;
    }
    Coolcar.login = login;
    function sendRequest(o, a) {
        const authOpt = a || {
            attachAuthHeader: true,
        };
        return new Promise((resolve, reject) => {
            const header = {};
            if (a.attachAuthHeader) {
                if (authData.token && authData.expireMs >= Date.now()) {
                    header.authorization = 'Bearer ' + authData.token;
                }
                else {
                    reject(AUTH_ERR);
                    return;
                }
            }
            if (authOpt.attachAuthHeader && authData.token && authData.expireMs >= Date.now()) {
                header.authorization = 'Bearer ' + authData.token;
            }
            wx.request({
                url: Coolcar.serverAddr + o.path,
                method: o.method,
                data: o.data,
                header,
                success: res => {
                    if (res.statusCode === 401) {
                        reject(AUTH_ERR);
                    }
                    else if (res.statusCode >= 400) {
                        reject(res);
                    }
                    else {
                        resolve(o.respMarshaller(camelcaseKeys(res.data, {
                            deep: true,
                        })));
                    }
                },
                fail: reject
            });
        });
    }
    function wxLogin() {
        return new Promise((resolve, reject) => {
            wx.login({
                success: resolve,
                fail: reject
            });
        });
    }
    function uploadfile(o) {
        const data = wx.getFileSystemManager().readFileSync(o.localPath);
        return new Promise((resolve, reject) => {
            wx.request({
                method: "PUT",
                data,
                url: o.url,
                success: res => {
                    if (res.statusCode >= 400) {
                        reject(res);
                    }
                    else {
                        resolve();
                    }
                },
                fail: reject,
            });
        });
    }
    Coolcar.uploadfile = uploadfile;
    function wxUploadFile(o, a) {
        const authOpt = a || {
            attachAuthHeader: true,
        };
        return new Promise((resolve, reject) => {
            const header = {};
            if (a.attachAuthHeader) {
                if (authData.token && authData.expireMs >= Date.now()) {
                    header.authorization = 'Bearer ' + authData.token;
                }
                else {
                    reject(AUTH_ERR);
                    return;
                }
            }
            if (authOpt.attachAuthHeader && authData.token && authData.expireMs >= Date.now()) {
                header.authorization = 'Bearer ' + authData.token;
            }
            wx.uploadFile({
                url: Coolcar.serverAddr + o.url,
                filePath: o.filePath,
                name: o.name,
                formData: o.formData,
                header,
                success: r => {
                    resolve(o.respMarshaller(r));
                },
                fail: reject
            });
        });
    }
    Coolcar.wxUploadFile = wxUploadFile;
})(Coolcar = exports.Coolcar || (exports.Coolcar = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0RBQWdEO0FBQ2hELHNEQUErQztBQUUvQyxJQUFpQixPQUFPLENBb012QjtBQXBNRCxXQUFpQixPQUFPO0lBRVAsa0JBQVUsR0FBRyx1QkFBdUIsQ0FBQTtJQUNwQyxjQUFNLEdBQUcscUJBQXFCLENBQUE7SUFDM0MsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFBO0lBRTNCLE1BQU0sUUFBUSxHQUFHO1FBQ2IsS0FBSyxFQUFDLEVBQUU7UUFDUixRQUFRLEVBQUMsQ0FBQztLQUNiLENBQUE7SUFjTSxLQUFLLFVBQVUsd0JBQXdCLENBQVUsQ0FBd0IsRUFBQyxDQUFhO1FBQzFGLE1BQU0sS0FBSyxFQUFFLENBQUE7UUFDYixNQUFNLE9BQU8sR0FBRyxDQUFDLElBQUk7WUFDakIsZ0JBQWdCLEVBQUUsSUFBSTtZQUN0QixnQkFBZ0IsRUFBRSxJQUFJO1NBQ3pCLENBQUE7UUFDRCxJQUFJO1lBQ0EsTUFBTSxLQUFLLEVBQUUsQ0FBQTtZQUNiLE9BQU8sV0FBVyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQTtTQUNqQztRQUFDLE9BQU0sR0FBRyxFQUFFO1lBQ1QsSUFBSSxHQUFHLEtBQUssUUFBUSxJQUFJLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDOUMsUUFBUSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUE7Z0JBQ25CLFFBQVEsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFBO2dCQUNyQixPQUFPLHdCQUF3QixDQUFDLENBQUMsRUFBRTtvQkFDL0IsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLGdCQUFnQjtvQkFDMUMsZ0JBQWdCLEVBQUUsS0FBSztpQkFDMUIsQ0FBQyxDQUFBO2FBQ0w7aUJBQU07Z0JBQ0gsTUFBTSxHQUFHLENBQUE7YUFDWjtTQUNKO0lBQ0wsQ0FBQztJQXJCcUIsZ0NBQXdCLDJCQXFCN0MsQ0FB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QUFTLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQTtpQkFDcEQ7cUJBQU07b0JBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO29CQUNoQixPQUFNO2lCQUNUO2FBQ0o7WUFDRCxJQUFJLE9BQU8sQ0FBQyxnQkFBZ0IsSUFBSSxRQUFRLENBQUMsS0FBSyxJQUFJLFFBQVEsQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFDO2dCQUM5RSxNQUFNLENBQUMsYUFBYSxHQUFHLFNBQVMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFBO2FBQ3BEO1lBRUQsRUFBRSxDQUFDLFVBQVUsQ0FBQztnQkFDVixHQUFHLEVBQUMsUUFBQSxVQUFVLEdBQUMsQ0FBQyxDQUFDLEdBQUc7Z0JBQ3BCLFFBQVEsRUFBRSxDQUFDLENBQUMsUUFBUTtnQkFDcEIsSUFBSSxFQUFDLENBQUMsQ0FBQyxJQUFJO2dCQUNYLFFBQVEsRUFBQyxDQUFDLENBQUMsUUFBUTtnQkFDbkIsTUFBTTtnQkFNTixPQUFPLEVBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ1IsT0FBTyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDaEMsQ0FBQztnQkFDRCxJQUFJLEVBQUMsTUFBTTthQUNkLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQXZDZSxvQkFBWSxlQXVDM0IsQ0FBQTtBQUNMLENBQUMsRUFwTWdCLE9BQU8sR0FBUCxlQUFPLEtBQVAsZUFBTyxRQW9NdkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2FtZWxjYXNlS2V5cyA9IHJlcXVpcmUoXCJjYW1lbGNhc2Uta2V5c1wiKVxyXG5pbXBvcnQgeyBhdXRoIH0gZnJvbSBcIi4vcHJvdG9fZ2VuL2F1dGgvYXV0aF9wYlwiXHJcblxyXG5leHBvcnQgbmFtZXNwYWNlIENvb2xjYXJ7XHJcblxyXG4gICAgZXhwb3J0IGNvbnN0IHNlcnZlckFkZHIgPSAnaHR0cDovL2xvY2FsaG9zdDo4MDgwJ1xyXG4gICAgZXhwb3J0IGNvbnN0IHdzQWRkciA9ICd3eDovL2xvY2FsaG9zdDo5MDkxJ1xyXG4gICAgY29uc3QgQVVUSF9FUlIgPSAnQVVUSF9FUlInXHJcblxyXG4gICAgY29uc3QgYXV0aERhdGEgPSB7XHJcbiAgICAgICAgdG9rZW46JycsXHJcbiAgICAgICAgZXhwaXJlTXM6MCxcclxuICAgIH1cclxuXHJcbiAgICBpbnRlcmZhY2UgUmVxdWVzdE9wdGlvbjxSRVEsUkVTPntcclxuICAgICAgICBtZXRob2Q6ICdHRVQnfCdQVVQnfCdQT1NUJ3wnREVMRVRFJ1xyXG4gICAgICAgIHBhdGg6c3RyaW5nXHJcbiAgICAgICAgZGF0YT86IFJFUVxyXG4gICAgICAgIHJlc3BNYXJzaGFsbGVyOihyOm9iamVjdCk9PlJFU1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBpbnRlcmZhY2UgQXV0aE9wdGlvbntcclxuICAgICAgICBhdHRhY2hBdXRoSGVhZGVyOmJvb2xlYW5cclxuICAgICAgICByZXRyeU9uQXV0aEVycm9yOiBib29sZWFuXHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRSZXF1ZXN0V2l0aEF1dGhSZXRyeTxSRVEsUkVTPihvOlJlcXVlc3RPcHRpb248UkVRLFJFUz4sYT86QXV0aE9wdGlvbik6IFByb21pc2U8UkVTPiAge1xyXG4gICAgICAgIGF3YWl0IGxvZ2luKClcclxuICAgICAgICBjb25zdCBhdXRoT3B0ID0gYSB8fCB7XHJcbiAgICAgICAgICAgIGF0dGFjaEF1dGhIZWFkZXI6IHRydWUsXHJcbiAgICAgICAgICAgIHJldHJ5T25BdXRoRXJyb3I6IHRydWUsXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IGxvZ2luKClcclxuICAgICAgICAgICAgcmV0dXJuIHNlbmRSZXF1ZXN0KG8sIGF1dGhPcHQpXHJcbiAgICAgICAgfSBjYXRjaChlcnIpIHtcclxuICAgICAgICAgICAgaWYgKGVyciA9PT0gQVVUSF9FUlIgJiYgYXV0aE9wdC5yZXRyeU9uQXV0aEVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBhdXRoRGF0YS50b2tlbiA9ICcnXHJcbiAgICAgICAgICAgICAgICBhdXRoRGF0YS5leHBpcmVNcyA9IDBcclxuICAgICAgICAgICAgICAgIHJldHVybiBzZW5kUmVxdWVzdFdpdGhBdXRoUmV0cnkobywge1xyXG4gICAgICAgICAgICAgICAgICAgIGF0dGFjaEF1dGhIZWFkZXI6IGF1dGhPcHQuYXR0YWNoQXV0aEhlYWRlcixcclxuICAgICAgICAgICAgICAgICAgICByZXRyeU9uQXV0aEVycm9yOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9naW4oKSB7XHJcbiAgICAgICAgaWYgKGF1dGhEYXRhLnRva2VuICYmIGF1dGhEYXRhLmV4cGlyZU1zID49IERhdGUubm93KCkpe1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgd3hSZXNwID0gYXdhaXQgd3hMb2dpbigpXHJcbiAgICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IHNlbmRSZXF1ZXN0PGF1dGgudjEuSUxvZ2luUmVxdWVzdCwgYXV0aC52MS5JTG9naW5SZXNwb25zZT4oe1xyXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcclxuICAgICAgICAgICAgcGF0aDogJy92MS9hdXRoL2xvZ2luJyxcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgY29kZTogd3hSZXNwLmNvZGUsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlc3BNYXJzaGFsbGVyOiBhdXRoLnYxLkxvZ2luUmVzcG9uc2UuZnJvbU9iamVjdCxcclxuICAgICAgICB9LHtcclxuICAgICAgICAgICAgYXR0YWNoQXV0aEhlYWRlcjogZmFsc2UsXHJcbiAgICAgICAgICAgIHJldHJ5T25BdXRoRXJyb3I6IGZhbHNlLFxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIGF1dGhEYXRhLnRva2VuID0gcmVzcC5hY2Nlc3NUb2tlbiFcclxuICAgICAgICBhdXRoRGF0YS5leHBpcmVNcyA9IERhdGUubm93KCkgKyByZXNwLmV4cGlyZXNJbiEgKiAxMDAwXHJcblxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBmdW5jdGlvbiBzZW5kUmVxdWVzdDxSRVEsUkVTPihvOiBSZXF1ZXN0T3B0aW9uPFJFUSwgUkVTPiwgYTogQXV0aE9wdGlvbik6IFByb21pc2U8UkVTPiB7XHJcbiAgICAgICAgY29uc3QgYXV0aE9wdCA9IGEgfHwge1xyXG4gICAgICAgICAgICBhdHRhY2hBdXRoSGVhZGVyOnRydWUsXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSxyZWplY3QpPT57XHJcbiAgICAgICAgICAgIGNvbnN0IGhlYWRlciA6IFJlY29yZDxzdHJpbmcsYW55PiA9IHt9Ly/pgb/lhY3kuIvovrnnmoRoZWFkZXIuYXV0aG9yaXphdGlvbiDngrnkuI3lh7rmnaXkuJzopb9cclxuICAgICAgICAgICAgaWYgKGEuYXR0YWNoQXV0aEhlYWRlcikge1xyXG4gICAgICAgICAgICAgICAgaWYgKGF1dGhEYXRhLnRva2VuICYmIGF1dGhEYXRhLmV4cGlyZU1zID49IERhdGUubm93KCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBoZWFkZXIuYXV0aG9yaXphdGlvbiA9ICdCZWFyZXIgJyArIGF1dGhEYXRhLnRva2VuXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChBVVRIX0VSUilcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoYXV0aE9wdC5hdHRhY2hBdXRoSGVhZGVyICYmIGF1dGhEYXRhLnRva2VuICYmIGF1dGhEYXRhLmV4cGlyZU1zID49IERhdGUubm93KCkpe1xyXG4gICAgICAgICAgICAgICAgaGVhZGVyLmF1dGhvcml6YXRpb24gPSAnQmVhcmVyICcgKyBhdXRoRGF0YS50b2tlblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHd4LnJlcXVlc3Qoe1xyXG4gICAgICAgICAgICAgICAgdXJsOnNlcnZlckFkZHIrby5wYXRoLFxyXG4gICAgICAgICAgICAgICAgbWV0aG9kOm8ubWV0aG9kLFxyXG4gICAgICAgICAgICAgICAgZGF0YTpvLmRhdGEsXHJcbiAgICAgICAgICAgICAgICBoZWFkZXIsXHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOnJlcz0+e1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gNDAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChBVVRIX0VSUilcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlcy5zdGF0dXNDb2RlID49IDQwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QocmVzKVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoby5yZXNwTWFyc2hhbGxlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVsY2FzZUtleXMocmVzLmRhdGEgYXMgb2JqZWN0LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVlcDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZmFpbDpyZWplY3RcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHd4TG9naW4oKTpQcm9taXNlPFdlY2hhdE1pbmlwcm9ncmFtLkxvZ2luU3VjY2Vzc0NhbGxiYWNrUmVzdWx0PntcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUscmVqZWN0KT0+e1xyXG4gICAgICAgICAgICB3eC5sb2dpbih7XHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOnJlc29sdmUsXHJcbiAgICAgICAgICAgICAgICBmYWlsOnJlamVjdFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGludGVyZmFjZSBVcGxvYWRGaWxlT3B0cyB7XHJcbiAgICAgICAgbG9jYWxQYXRoOiBzdHJpbmdcclxuICAgICAgICB1cmw6IHN0cmluZ1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBmdW5jdGlvbiB1cGxvYWRmaWxlKG86VXBsb2FkRmlsZU9wdHMpOlByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB3eC5nZXRGaWxlU3lzdGVtTWFuYWdlcigpLnJlYWRGaWxlU3luYyhvLmxvY2FsUGF0aClcclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLHJlamVjdCk9PntcclxuICAgICAgICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICAgICAgICBtZXRob2Q6XCJQVVRcIixcclxuICAgICAgICAgICAgICAgIGRhdGEsXHJcbiAgICAgICAgICAgICAgICB1cmw6by51cmwsXHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOnJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID49IDQwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QocmVzKSAgIFxyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICAgICAgICAgICAgICB9ICAgIFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGZhaWw6cmVqZWN0LFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBpbnRlcmZhY2Ugd3hVcGxvYWRGaWxlT3B0cyB7XHJcbiAgICAgICAgbG9jYWxQYXRoOiBzdHJpbmdcclxuICAgIH1cclxuXHJcblxyXG4gICAgZXhwb3J0IGludGVyZmFjZSBVcGxvYWRPcHRpb248VVBSRVEsVVBSRVM+e1xyXG4gICAgICAgIGZpbGVQYXRoOiBzdHJpbmcsXHJcbiAgICAgICAgdXJsOnN0cmluZyxcclxuICAgICAgICBuYW1lOnN0cmluZyxcclxuICAgICAgICBmb3JtRGF0YTpVUFJFUSxcclxuICAgICAgICByZXNwTWFyc2hhbGxlcjoocjpvYmplY3QpPT5VUFJFU1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBmdW5jdGlvbiB3eFVwbG9hZEZpbGU8VVBSRVEsVVBSRVM+KG86IFVwbG9hZE9wdGlvbjxVUFJFUSwgVVBSRVM+LCBhOiBBdXRoT3B0aW9uKTpQcm9taXNlPFVQUkVTPiB7XHJcbiAgICAgICAgY29uc3QgYXV0aE9wdCA9IGEgfHwge1xyXG4gICAgICAgICAgICBhdHRhY2hBdXRoSGVhZGVyOnRydWUsXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IGhlYWRlciA6IFJlY29yZDxzdHJpbmcsYW55PiA9IHtcclxuICAgICAgICAgICAgICAgIC8vJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uO3V0Zi04J1xyXG4gICAgICAgICAgICB9Ly/pgb/lhY3kuIvovrnnmoRoZWFkZXIuYXV0aG9yaXphdGlvbiDngrnkuI3lh7rmnaXkuJzopb9cclxuICAgICAgICAgICAgaWYgKGEuYXR0YWNoQXV0aEhlYWRlcikge1xyXG4gICAgICAgICAgICAgICAgaWYgKGF1dGhEYXRhLnRva2VuICYmIGF1dGhEYXRhLmV4cGlyZU1zID49IERhdGUubm93KCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBoZWFkZXIuYXV0aG9yaXphdGlvbiA9ICdCZWFyZXIgJyArIGF1dGhEYXRhLnRva2VuXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChBVVRIX0VSUilcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoYXV0aE9wdC5hdHRhY2hBdXRoSGVhZGVyICYmIGF1dGhEYXRhLnRva2VuICYmIGF1dGhEYXRhLmV4cGlyZU1zID49IERhdGUubm93KCkpe1xyXG4gICAgICAgICAgICAgICAgaGVhZGVyLmF1dGhvcml6YXRpb24gPSAnQmVhcmVyICcgKyBhdXRoRGF0YS50b2tlblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB3eC51cGxvYWRGaWxlKHtcclxuICAgICAgICAgICAgICAgIHVybDpzZXJ2ZXJBZGRyK28udXJsLFxyXG4gICAgICAgICAgICAgICAgZmlsZVBhdGg6IG8uZmlsZVBhdGgsXHJcbiAgICAgICAgICAgICAgICBuYW1lOm8ubmFtZSxcclxuICAgICAgICAgICAgICAgIGZvcm1EYXRhOm8uZm9ybURhdGEsXHJcbiAgICAgICAgICAgICAgICBoZWFkZXIsXHJcbiAgICAgICAgICAgICAgICAvLyBoZWFkZXJzIDoge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAndGltZXN0YW1wJzogJzE2NDE3MDQzMzcnLFxyXG4gICAgICAgICAgICAgICAgLy8gICAgICAnYXV0aG9yaXphdGlvbic6ICcxRDYzRTZGMUY4QUY3QkQ2MjlDNjg0QTE0NDY4MzIyNicsXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjt1dGYtOCdcclxuICAgICAgICAgICAgICAgIC8vIH0sXHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoby5yZXNwTWFyc2hhbGxlcihyKSlcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBmYWlsOnJlamVjdFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn0iXX0=